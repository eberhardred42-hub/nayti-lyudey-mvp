# Admin Security Notes

Этот документ — правила безопасности для админки (что нельзя делать/логировать) и практики ротации доступов.

## PII/секреты: что нельзя логировать

Запрещено добавлять в логи/артефакты/аудит (включая `admin_event`, `alert_event`, `admin_audit_log.summary` и любые server logs):

- `admin_password` (в любом виде)
- `X-Admin-Token` (plain)
- `Authorization: Bearer <user_token>` (plain)
- OTP code (одноразовый код)
- Полные E.164 телефоны (в логах допускается только маскирование)
- S3 креды (`S3_SECRET_KEY`, access keys), presigned URL (как “секретоподобный” URL)
- Любые персональные данные из payload’ов, если появятся в будущем (ФИО, email, и т.п.)

Рекомендация: хранить только hash/идентификаторы (`user_id`, `request_id`, `render_job_id`) и маскированные телефоны.

## Ротация admin password

В этом репо админ‑пароль задаётся через:
- `ADMIN_PASSWORD_SALT`
- `ADMIN_PASSWORD_HASH`

Алгоритм: `PBKDF2-HMAC-SHA256(password, salt, 100000)` → hex.

Процедура ротации (staging/prod):

1) Сгенерировать новый `ADMIN_PASSWORD_SALT` (случайный) и новый `ADMIN_PASSWORD_HASH`.
2) Обновить секреты окружения (не в git) и перезапустить `api`.
3) Учесть, что смена `ADMIN_PASSWORD_SALT` инвалидирует существующие admin sessions (так как проверка `X-Admin-Token` использует текущую salt).
4) Проверить вход админа по allowlist+пароль.

Важно: не хранить пароль в истории shell и CI логах.

## Как добавить второй номер в allowlist

Allowlist — env переменная `ADMIN_PHONE_ALLOWLIST` (comma-separated E.164).

Безопасная процедура:

1) Добавить новый номер в allowlist в секрет‑хранилище/переменных окружения окружения (пример: `+79990000000,+79990000001`).
2) Перезапустить `api`.
3) Проверить, что пользователь может пройти OTP (mock) / получить Bearer token и выполнить `POST /admin/login`.

## Минимальный принцип доступа

- Держать allowlist минимальным.
- Срок жизни сессий — ограниченный (см. `ADMIN_SESSION_TTL_HOURS`).
- Менять конфиги и права документов только через админку и только в staging.

## Безопасность UI/Logs

- В UI Logs Viewer есть клиентское маскирование JSON, но это не заменяет серверные правила: лучше не логировать чувствительные данные вообще.
