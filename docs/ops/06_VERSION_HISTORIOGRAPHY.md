# Историография версий (зачем и что меняли)

Цель этого файла — чтобы по одной строке было понятно: **какая проблема была у версии**, **что именно сделали**, и **каким измеримым чекпоинтом это принималось**.

Правило (из ops): для каждой продуктовой задачи — bump `VERSION` (+1) и обновить этот файл.

## Чекпоинты (определения)

- **A — LLM:** `POST /api/health/llm/ping` → 200 и есть `latency_ms` (реальный запрос наружу).
- **B — Brief:** пройти бриф ≤ 10 вопросов → `ready_to_search=true`.
- **C — Paid doc + wallet:** сгенерить 1 платный документ → появился `wallet.debit`, документ доступен на скачивание.

## Версии

### v1.7 — Observability + CI дисциплина
- Фокус: наблюдаемость и предсказуемые релизы.
- Что сделали: trace-события (intro/LLM/render/S3) в `artifacts`, просмотр через `/admin/logs`; CI переведён в manual-only, DEV deploy оставил только быстрые curl-проверки.
- Зачем: чтобы отлаживать E2E по логам и не убивать скорость релизов.
- Приёмка: наличие trace по ключевым шагам в `/admin/logs`.

### v1.8 — LLM обязателен на стенде
- Фокус: убрать “тихий мок” там, где нужен реальный LLM.
- Что сделали: деплой падает без ключа при требовании; `/api/health/llm` показывает provider/model/base_url/key_present/mode.
- Зачем: чтобы DEV/PROD не становились «всё работает, но на моках».
- Приёмка: чекпоинт **A** проходит на DEV.

### v1.10 — Стабильный runtime env на сервере
- Фокус: чтобы compose всегда подхватывал правильный LLM-конфиг.
- Что сделали: исправлена генерация runtime `.env` в GitHub Actions.
- Зачем: уменьшить “works on my machine” и дрейф окружений.
- Приёмка: `GET /api/health/llm` отражает ожидаемые env на DEV.

### v2.0 — Guest auth без логина
- Фокус: E2E без регистрации.
- Что сделали: `POST /sessions` выдаёт HttpOnly cookie; `/api/me/documents` для гостя возвращает 200 (не 401); фронт шлёт cookies через `credentials: "include"`.
- Зачем: чтобы флоу «зашёл → попробовал → получил документы» был бесшовным.
- Приёмка: E2E без логина не спотыкается на 401.

### v2.1 — DEV Deploy: smoke warn-only
- Фокус: скорость итераций.
- Что сделали: smoke checks на DEV сделаны non-blocking (warn-only) с ретраями.
- Зачем: smoke должен сигналить, но не блокировать релиз.
- Приёмка: DEV deploy не падает из-за smoke.

### v2.2 — Auth self-heal + ручной LLM ping
- Фокус: “самоисцеление” гостевой сессии и измеримый LLM.
- Что сделали: битая/просроченная cookie сбрасывается и перевыдаётся; Domain разведен для DEV/PROD; добавлен `POST /api/health/llm/ping`.
- Зачем: минимизировать 401/сломанные сессии, и иметь явный тест реального LLM.
- Приёмка: чекпоинт **A** проходит, а guest не получает 401 из-за мусорной cookie.

### v2.3 — STOP 401 (host-only cookie) + auth health
- Фокус: “железобетонный” guest auth.
- Что сделали: host-only cookie `__Host-nly_auth` (без Domain) + cleanup legacy `nly_auth`; `POST /api/sessions` и `GET /api/me/documents` не возвращают 401 без Bearer; добавлен `GET /api/health/auth`.
- Зачем: прекратить классы багов с Domain/поддоменами.
- Приёмка: 401 без Bearer не воспроизводится на DEV.

### v2.4 — LLM provider switch только через env
- Фокус: управляемость провайдера без правок кода.
- Что сделали: переключение через `LLM_BASE_URL/LLM_API_KEY/LLM_MODEL`; PROD deploy поддерживает `PROD_LLM_*`.
- Зачем: менять провайдера — операционная операция, а не разработка.
- Приёмка: `GET /api/health/llm` показывает ожидаемый provider/base_url/model на DEV/PROD.

### v2.5 — Manual `LLM Ping (DEV)`
- Фокус: отдельный измеримый тест интеграции.
- Что сделали: workflow `LLM Ping (DEV)` переведён на `workflow_dispatch`.
- Зачем: проверять LLM без деплоя/изменений кода.
- Приёмка: чекпоинт **A** проходит через workflow.

### v2.6 — DEV: фикс 502 в Caddy + строгие DEV_LLM_*/PROD_LLM_*
- Фокус: стабильность прокси/инфры и разделение окружений.
- Что сделали: фикс 502 (IPv6 `localhost`), LLM строго через `DEV_LLM_*`/`PROD_LLM_*`, sanity-check домена на DEV deploy.
- Зачем: убрать сетевые “фантомы” и случайные конфиги.
- Приёмка: `https://dev.naitilyudei.ru/api/docs` стабильно 200.

### v2.7 — Ops система в репозитории
- Фокус: быстрый онбординг + измеримый прогресс.
- Что сделали: добавлен [HANDOVER_PROMPT.md](../../HANDOVER_PROMPT.md), папка [docs/ops/](.) (rules/runbooks/templates), PR template, чекпоинты дня в README.
- Зачем: чтобы «вход за 5 минут» и ежедневные A/B/C стали нормой.
- Приёмка: любой новый агент может начать с README → handover → rules и воспроизвести чекпоинты.

### v2.8 — DEV диагностика + устойчивый sanity-check
- Фокус: сделать DEV тестируемым и надёжным сегодня.
- Что сделали:
	- добавлен ручной workflow `DEV Diagnose` (без SSH) для детерминированной диагностики 502;
	- DEV Deploy: sanity-check разделён на blocking (локальный upstream) и warn-only (домен);
	- доменный sanity-check больше не пытается парсить JSON при non-200/не-JSON (нет `JSONDecodeError`).
- Зачем: домен может флапать/давать 502, но деплой должен быть стабильным и давать понятную диагностику.
- Приёмка: чекпоинт **A** (домен 200) и/или хотя бы детерминированная диагностика через workflow.

### v2.9 — DEV Deploy: фикс ложных фейлов blocking sanity-check
- Фокус: сделать blocking-check реально блокирующим, а не “ложно красным”.
- Что сделали:
	- DEV Deploy: исправлен баг `curl | python3 - <<HEREDOC` (stdin конфликт → пустой JSON → вечный `JSONDecodeError`);
	- парсинг JSON теперь только при `HTTP 200` и `Content-Type: application/json` (и для локального upstream, и для ping, и для домена);
	- при падении локального upstream добавлена диагностика (compose ps, tail api logs, слушатель на :8100).
- Зачем: чтобы Actions давали детерминированную причину падения без SSH.
- Приёмка: DEV deploy перестаёт падать “сам по себе”, а если падает — в логе есть причина.

### v2.10 — DEV Deploy: итоговый summary в Actions
- Фокус: ускорить чтение результатов run “за 10 секунд”.
- Что сделали: в DEV Deploy добавлен `Summary` шаг (`$GITHUB_STEP_SUMMARY`), который показывает статусы: local upstream (blocking), local LLM ping, domain check, smoke.
- Зачем: чтобы проджект/QA могли быстро понять состояние стенда без просмотра всех шагов.
- Приёмка: в каждом run DEV Deploy внизу виден summary с перечисленными статусами.

### v2.11 — Intro P0: детерминированный бриф ≤10 + paywall UI
- Фокус: полный DEV user path «ввод роли → бриф ≤10 → free previews + locked docs», без автогенерации до оплаты.
- Что сделали:
	- новый движок интро [api/intro_engine.py](../../api/intro_engine.py): детерминированный порядок полей, лимит 10 вопросов, confirm/correct, STOP rule (после `ready_to_search=true` никаких вопросов и LLM вызовов);
	- /api/chat/message возвращает контракт для UI: `type`, `progress`, `target_field`, `question_text`, `propose_value`, `ui_mode`, `brief_snapshot`; на `intro_done` — `free_documents` и `locked_documents` (150₽) без генерации;
	- frontend: новый UX брифа и экран `intro_done` (free markdown previews + locked карточки);
	- добавлены unit-тесты интро-движка и ручной smoke workflow для DEV.
- Зачем: сделать флоу предсказуемым, проверяемым и соответствующим правилу «не генерим до оплаты».
- Приёмка: чекпоинты **A** (LLM ping) и **B** (brief ≤10 → `ready_to_search=true`) + ручная проверка отсутствия автогенерации.

### v2.12 — DEV E2E journey: auth+wallet+paid docs + entry modes
- Фокус: сделать флоу на DEV проходимым end-to-end (UI + LLM + Auth + Wallet).
- Что сделали:
	- entry modes на UI (A: текст вакансии, C: ≤10 вопросов) и прокидка `entry_mode` в `/sessions`;
	- OTP auth через Redis (и алиасы), `/me` с балансом; seed кошелька для admin телефона `89062592834` (= 1_000_000);
	- платные документы: debit 150₽ при генерации (и событие в `artifacts`, видно в `/admin/logs`);
	- клиентские события пишутся в `artifacts` через `/events/client`.
- Зачем: чтобы PM/QA могли пройти путь руками и проверить чекпоинты A/B/C без тяжёлых смоков на деплое.
- Приёмка:
	- чекпоинт **A** проходит (`POST /api/health/llm/ping` → 200);
	- чекпоинт **B** проходит (интро ≤10 вопросов → done);
	- чекпоинт **C** проходит (генерация платного дока списывает 150 и видно `wallet_debit` в `/admin/logs`);
	- ручной workflow `Product Smoke (DEV)` проходит.

### v2.13 — Offer gate + Redis tokens + doc polling
- Фокус: убрать флейк юзер-сессий после деплоя и сделать оплату юридически/технически “настоящей”.
- Что сделали:
	- Bearer-токены сохраняются в Redis (переживают рестарт/деплой), `_require_bearer_user` подхватывает их из Redis;
	- `/legal/offer/accept` требует Bearer и пишет acceptance в DB; платные документы возвращают `412 offer_not_accepted` если оферта не принята;
	- UI после покупки поллит `/api/me/documents`, чтобы автоматически показать `download_url` когда документ готов.
- Зачем: чтобы PM мог пройти путь без “401 после деплоя” и без формальной галочки.
- Приёмка: чекпоинт **C** проходит после рестарта API; попытка генерации платного дока без оферты даёт 412.

### v2.14 — Offer auto-heal (412 → accept → retry)
- Фокус: убрать тупик при `412 offer_not_accepted` в UI.
- Что сделали: UI при 412 автоматически вызывает `/legal/offer/accept` и повторяет генерацию один раз.
- Зачем: чтобы путь “логин → покупка → генерация” был проходимым даже если acceptance не успел записаться.
- Приёмка: с валидным Bearer на попытке платной генерации после 412 происходит auto-retry и документ уходит в генерацию.

### v2.15 — UX insufficient funds (pre-check)
- Фокус: не давать пользователю упираться в ошибку списания после клика.
- Что сделали: UI считает стоимость выбранных платных документов, подгружает баланс по `/me` на экране `done` и дизейблит кнопку покупки при нехватке.
- Приёмка: при выборе документов на сумму больше баланса кнопка недоступна и показывается “не хватает N ₽”.

## Шаблон для новой версии

### vX.Y — <короткий фокус>
- Фокус:
- Что сделали:
- Зачем:
- Приёмка: (A/B/C + ссылка на Actions run)
