# Историография версий (зачем и что меняли)

Цель этого файла — чтобы по одной строке было понятно: **какая проблема была у версии**, **что именно сделали**, и **каким измеримым чекпоинтом это принималось**.

Правило (из ops): для каждой продуктовой задачи — bump `VERSION` (+1) и обновить этот файл.

## Чекпоинты (определения)

- **A — LLM:** `POST /api/health/llm/ping` → 200 и есть `latency_ms` (реальный запрос наружу).
- **B — Brief:** пройти бриф ≤ 10 вопросов → `ready_to_search=true`.
- **C — Paid doc + wallet:** сгенерить 1 платный документ → появился `wallet.debit`, документ доступен на скачивание.

## Версии

### v1.7 — Observability + CI дисциплина
- Фокус: наблюдаемость и предсказуемые релизы.
- Что сделали: trace-события (intro/LLM/render/S3) в `artifacts`, просмотр через `/admin/logs`; CI переведён в manual-only, DEV deploy оставил только быстрые curl-проверки.
- Зачем: чтобы отлаживать E2E по логам и не убивать скорость релизов.
- Приёмка: наличие trace по ключевым шагам в `/admin/logs`.

### v1.8 — LLM обязателен на стенде
- Фокус: убрать “тихий мок” там, где нужен реальный LLM.
- Что сделали: деплой падает без ключа при требовании; `/api/health/llm` показывает provider/model/base_url/key_present/mode.
- Зачем: чтобы DEV/PROD не становились «всё работает, но на моках».
- Приёмка: чекпоинт **A** проходит на DEV.

### v1.10 — Стабильный runtime env на сервере
- Фокус: чтобы compose всегда подхватывал правильный LLM-конфиг.
- Что сделали: исправлена генерация runtime `.env` в GitHub Actions.
- Зачем: уменьшить “works on my machine” и дрейф окружений.
- Приёмка: `GET /api/health/llm` отражает ожидаемые env на DEV.

### v2.0 — Guest auth без логина
- Фокус: E2E без регистрации.
- Что сделали: `POST /sessions` выдаёт HttpOnly cookie; `/api/me/documents` для гостя возвращает 200 (не 401); фронт шлёт cookies через `credentials: "include"`.
- Зачем: чтобы флоу «зашёл → попробовал → получил документы» был бесшовным.
- Приёмка: E2E без логина не спотыкается на 401.

### v2.1 — DEV Deploy: smoke warn-only
- Фокус: скорость итераций.
- Что сделали: smoke checks на DEV сделаны non-blocking (warn-only) с ретраями.
- Зачем: smoke должен сигналить, но не блокировать релиз.
- Приёмка: DEV deploy не падает из-за smoke.

### v2.2 — Auth self-heal + ручной LLM ping
- Фокус: “самоисцеление” гостевой сессии и измеримый LLM.
- Что сделали: битая/просроченная cookie сбрасывается и перевыдаётся; Domain разведен для DEV/PROD; добавлен `POST /api/health/llm/ping`.
- Зачем: минимизировать 401/сломанные сессии, и иметь явный тест реального LLM.
- Приёмка: чекпоинт **A** проходит, а guest не получает 401 из-за мусорной cookie.

### v2.3 — STOP 401 (host-only cookie) + auth health
- Фокус: “железобетонный” guest auth.
- Что сделали: host-only cookie `__Host-nly_auth` (без Domain) + cleanup legacy `nly_auth`; `POST /api/sessions` и `GET /api/me/documents` не возвращают 401 без Bearer; добавлен `GET /api/health/auth`.
- Зачем: прекратить классы багов с Domain/поддоменами.
- Приёмка: 401 без Bearer не воспроизводится на DEV.

### v2.4 — LLM provider switch только через env
- Фокус: управляемость провайдера без правок кода.
- Что сделали: переключение через `LLM_BASE_URL/LLM_API_KEY/LLM_MODEL`; PROD deploy поддерживает `PROD_LLM_*`.
- Зачем: менять провайдера — операционная операция, а не разработка.
- Приёмка: `GET /api/health/llm` показывает ожидаемый provider/base_url/model на DEV/PROD.

### v2.5 — Manual `LLM Ping (DEV)`
- Фокус: отдельный измеримый тест интеграции.
- Что сделали: workflow `LLM Ping (DEV)` переведён на `workflow_dispatch`.
- Зачем: проверять LLM без деплоя/изменений кода.
- Приёмка: чекпоинт **A** проходит через workflow.

### v2.6 — DEV: фикс 502 в Caddy + строгие DEV_LLM_*/PROD_LLM_*
- Фокус: стабильность прокси/инфры и разделение окружений.
- Что сделали: фикс 502 (IPv6 `localhost`), LLM строго через `DEV_LLM_*`/`PROD_LLM_*`, sanity-check домена на DEV deploy.
- Зачем: убрать сетевые “фантомы” и случайные конфиги.
- Приёмка: `https://dev.naitilyudei.ru/api/docs` стабильно 200.

### v2.7 — Ops система в репозитории
- Фокус: быстрый онбординг + измеримый прогресс.
- Что сделали: добавлен [HANDOVER_PROMPT.md](../../HANDOVER_PROMPT.md), папка [docs/ops/](.) (rules/runbooks/templates), PR template, чекпоинты дня в README.
- Зачем: чтобы «вход за 5 минут» и ежедневные A/B/C стали нормой.
- Приёмка: любой новый агент может начать с README → handover → rules и воспроизвести чекпоинты.

## Шаблон для новой версии

### vX.Y — <короткий фокус>
- Фокус:
- Что сделали:
- Зачем:
- Приёмка: (A/B/C + ссылка на Actions run)
