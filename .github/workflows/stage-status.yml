name: Stage Status

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Environment (dev|prod)"
        required: true
        default: "prod"

jobs:
  status:
    runs-on: [self-hosted, stage]
    steps:
      - name: Print status + last logs
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ inputs.env }}"
          case "$ENV" in
            prod) PROJECT=prod; BASE_URL=https://naitilyudei.ru ;;
            dev) PROJECT=dev; BASE_URL=https://dev.naitilyudei.ru ;;
            *) echo "Invalid env: $ENV (expected dev|prod)"; exit 1 ;;
          esac

          cd "$HOME/app"
          docker compose -p "$PROJECT" -f infra/docker-compose.yml ps
          echo "---- CADDY LOGS ----"
          docker logs --tail=100 caddy || true
          echo "---- STACK LOGS ----"
          docker compose -p "$PROJECT" -f infra/docker-compose.yml logs --no-color --tail=120 || true
          echo "---- SMOKE ----"
          curl -I "$BASE_URL/api/docs" | head -n 5 || true
