name: PROD Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to deploy (branch/tag/sha)"
        required: true
        default: "main"

jobs:
  deploy:
    runs-on: [self-hosted, stage]

    steps:
      - name: Deploy from ~/app (git pull + compose up)
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="$HOME/app"
          REPO_URL="https://github.com/eberhardred42-hub/nayti-lyudey-mvp.git"

          if [ ! -d "$APP_DIR/.git" ]; then
            mkdir -p "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
          fi

          cd "$APP_DIR"
          git fetch --all
          git fetch --tags

          if [ "${{ inputs.ref }}" = "main" ]; then
            git reset --hard origin/main
          else
            git checkout --detach "${{ inputs.ref }}"
            git reset --hard "${{ inputs.ref }}"
          fi

          export FRONT_HOST_PORT=3000
          export API_HOST_PORT=8000
          export ML_HOST_PORT=8001
          export RENDER_HOST_PORT=8002
          export MINIO_HOST_PORT=9000
          export MINIO_CONSOLE_HOST_PORT=9001
          export DB_HOST_PORT=5432
          export REDIS_HOST_PORT=6379
          export S3_PRESIGN_ENDPOINT=${S3_PRESIGN_ENDPOINT:-http://localhost:9000}

          docker compose -p prod -f infra/docker-compose.yml up -d --build

      - name: Ensure caddy is running (host network)
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="$HOME/app"

          if ! docker ps -a --format '{{.Names}}' | grep -qx 'caddy'; then
            docker run -d --name caddy --restart unless-stopped --network host \
              -v "$APP_DIR/Caddyfile:/etc/caddy/Caddyfile" \
              -v caddy_data:/data -v caddy_config:/config caddy:2
          else
            docker restart caddy
          fi

      - name: Smoke checks
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS https://naitilyudei.ru/ >/dev/null
          curl -fsS https://naitilyudei.ru/api/docs >/dev/null
          cd "$HOME/app"
          docker compose -p prod -f infra/docker-compose.yml ps

      - name: Logs (only if failed)
        if: failure()
        shell: bash
        run: |
          cd "$HOME/app"
          docker logs --tail=200 caddy || true
          docker compose -p prod -f infra/docker-compose.yml logs --no-color --tail=200 || true
