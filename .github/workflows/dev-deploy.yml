name: DEV Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, stage]
    env:
      DEV_LLM_BASE_URL: ${{ secrets.DEV_LLM_BASE_URL }}
      DEV_LLM_API_KEY: ${{ secrets.DEV_LLM_API_KEY }}
      DEV_LLM_MODEL: ${{ vars.DEV_LLM_MODEL }}
      NLY_ENV: dev
      LLM_PROVIDER: openai_compat
      LLM_REQUIRE_KEY: "true"

    steps:
      - name: Deploy DEV from ~/app (git pull + compose up)
        shell: bash
        run: |
          set -euo pipefail

          APP_DIR="$HOME/app"
          REPO_URL="https://github.com/eberhardred42-hub/nayti-lyudey-mvp.git"

          if [ ! -d "$APP_DIR/.git" ]; then
            mkdir -p "$APP_DIR"
            git clone "$REPO_URL" "$APP_DIR"
          fi

          cd "$APP_DIR"
          git fetch --all
          git reset --hard origin/main

          # Some hosts may have had Caddyfile locally modified and marked as
          # skip-worktree/assume-unchanged. Make sure the repo version is applied.
          git update-index --no-skip-worktree Caddyfile 2>/dev/null || true
          git update-index --no-assume-unchanged Caddyfile 2>/dev/null || true
          git checkout -- Caddyfile || true

          # DEV ports (must not conflict with PROD)
          export FRONT_HOST_PORT=3100
          export API_HOST_PORT=8100
          export ML_HOST_PORT=8101
          export RENDER_HOST_PORT=8102
          export MINIO_HOST_PORT=9100
          export MINIO_CONSOLE_HOST_PORT=9101
          export DB_HOST_PORT=15432
          export REDIS_HOST_PORT=16379
          export S3_PRESIGN_ENDPOINT=${S3_PRESIGN_ENDPOINT:-http://localhost:9100}

          # Deterministic runtime env
          # - write to .env.runtime (requested)
          # - also copy to .env so docker compose always picks it up
          RUNTIME_ENV_FILE="$APP_DIR/.env.runtime"

          if [ -z "${DEV_LLM_API_KEY:-}" ]; then
            echo "ERROR: DEV_LLM_API_KEY is not set" >&2
            exit 1
          fi
          if [ -z "${DEV_LLM_BASE_URL:-}" ]; then
            echo "ERROR: DEV_LLM_BASE_URL is not set" >&2
            exit 1
          fi
          umask 077
          {
            printf '%s\n' "NLY_ENV=dev"
            printf '%s\n' "LLM_PROVIDER=openai_compat"
            printf '%s\n' "LLM_REQUIRE_KEY=true"
            printf '%s\n' "DEV_LLM_BASE_URL=${DEV_LLM_BASE_URL}"
            printf '%s\n' "DEV_LLM_MODEL=${DEV_LLM_MODEL:-llama-3.1-8b-instant}"
            printf '%s\n' "DEV_LLM_API_KEY=${DEV_LLM_API_KEY}"
          } >"$RUNTIME_ENV_FILE"
          chmod 600 "$RUNTIME_ENV_FILE" || true

          cp "$RUNTIME_ENV_FILE" "$APP_DIR/.env"
          chmod 600 "$APP_DIR/.env" || true

          echo "== runtime env written: $RUNTIME_ENV_FILE (redacted) =="
          sed -E 's/(DEV_LLM_API_KEY=).+/\1***REDACTED***/' "$RUNTIME_ENV_FILE" | sed -n '1,30p'

          docker compose -p dev -f infra/docker-compose.yml up -d --build --force-recreate

      - name: Ensure caddy is running (host network)
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="$HOME/app"

          echo "== Caddyfile (host) reverse_proxy lines =="
          sed -n '1,160p' "$APP_DIR/Caddyfile" | grep -n 'reverse_proxy' || true

          if docker ps -a --format '{{.Names}}' | grep -qx 'caddy'; then
            mode="$(docker inspect -f '{{.HostConfig.NetworkMode}}' caddy 2>/dev/null || true)"
            caddyfile_src="$(docker inspect -f '{{ range .Mounts }}{{ if eq .Destination "/etc/caddy/Caddyfile" }}{{ .Source }}{{ end }}{{ end }}' caddy 2>/dev/null || true)"
            if [ "$mode" != "host" ] || [ "$caddyfile_src" != "$APP_DIR/Caddyfile" ]; then
              echo "Recreating caddy (mode=$mode, Caddyfile mount=$caddyfile_src)"
              docker rm -f caddy || true
            fi
          fi

          if ! docker ps -a --format '{{.Names}}' | grep -qx 'caddy'; then
            docker run -d --name caddy --restart unless-stopped --network host \
              -v "$APP_DIR/Caddyfile:/etc/caddy/Caddyfile" \
              -v caddy_data:/data -v caddy_config:/config caddy:2
          else
            docker restart caddy
          fi

          echo "== Caddyfile (container) reverse_proxy lines =="
          docker exec caddy sh -lc 'sed -n "1,160p" /etc/caddy/Caddyfile | grep -n "reverse_proxy" || true' || true

      - name: Sanity-check local upstream (blocking)
        shell: bash
        run: |
          set -euo pipefail
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8100/health/llm \
              | python3 - <<'PY'
          import json,sys
          j=json.load(sys.stdin)
          assert j.get('ok') is True, j
          PY
            then
              echo "Local upstream sanity OK"
              exit 0
            fi
            echo "Local upstream sanity retry $i/60"
            sleep 2
          done
          echo "Local upstream sanity FAILED" >&2
          exit 1

      - name: Sanity-check domain (warn-only)
        continue-on-error: true
        shell: bash
        run: |
          set -euo pipefail

          url="https://dev.naitilyudei.ru/api/health/llm"
          hdr="/tmp/dev_domain.hdr"
          body="/tmp/dev_domain.body"

          http_code="$(curl -sS -4 --max-time 15 -D "$hdr" -o "$body" -w '%{http_code}' "$url" || true)"
          content_type="$(grep -i '^content-type:' "$hdr" | head -n1 | tr -d '\r' || true)"

          echo "Domain check: $url"
          echo "HTTP: ${http_code:-<none>}"
          echo "${content_type:-Content-Type: <missing>}"

          if [ "$http_code" != "200" ]; then
            echo "WARN: non-200 from domain (not blocking). Body excerpt:"
            head -c 200 "$body" || true
            echo
            exit 0
          fi

          if ! echo "$content_type" | grep -qi 'application/json'; then
            echo "WARN: 200 but non-JSON Content-Type (not blocking). Body excerpt:"
            head -c 200 "$body" || true
            echo
            exit 0
          fi

          if python3 - <<'PY' <"$body"; then
          import json,sys
          j=json.load(sys.stdin)
          assert j.get('ok') is True, j
          print('Domain JSON ok:true')
          PY
            exit 0
          else
            echo "WARN: JSON parse/assert failed (not blocking). Body excerpt:"
            head -c 200 "$body" || true
            echo
            exit 0
          fi

      - name: Smoke checks (DEV) - non blocking
        continue-on-error: true
        shell: bash
        run: |
          set -e
          for i in $(seq 1 20); do
            if curl -fsS -4 https://dev.naitilyudei.ru/api/health/llm >/dev/null; then
              echo "Smoke OK"
              exit 0
            fi
            sleep 1
          done
          echo "Smoke FAILED (warn only)"

      - name: Logs (only if failed)
        if: failure()
        shell: bash
        run: |
          cd "$HOME/app"
          docker logs --tail=200 caddy || true
          docker compose -p dev -f infra/docker-compose.yml logs --no-color --tail=200 || true
